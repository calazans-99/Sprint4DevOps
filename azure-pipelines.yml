# ================================================================
# Azure DevOps Pipeline (YAML) – Sprint4DevOps
# CI: build + testes + artefato
# CD: deploy para Azure App Service (Linux) – Java 17 (Spring Boot .jar)
# ================================================================

trigger:
  branches:
    include:
      - main

variables:
  azureSubscription: 'SC_Sprint4Devops'                 # Service Connection
  appName: 'app-sprint4-rm556620'                       # App Service
  artifactName: 'drop'
  # O DownloadPipelineArtifact coloca o conteúdo do artefato em $(Pipeline.Workspace)/<ArtifactName>
  packagePath: '$(Pipeline.Workspace)/$(artifactName)/**/*.jar'

pool:
  vmImage: 'ubuntu-latest'

stages:
# =========================
# BUILD
# =========================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: Build
        displayName: 'Maven build + tests'
        steps:
          - checkout: self

          # Java 17
          - task: JavaToolInstaller@0
            displayName: 'Set Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # Garantir diretório do cache Maven (sem usar ~)
          - bash: mkdir -p "$(Pipeline.Workspace)/.m2/repository"
            displayName: 'Garantir diretório Maven local (cache)'

          # Cache do repositório Maven
          - task: Cache@2
            displayName: 'Cache Maven local'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: '$(Pipeline.Workspace)/.m2/repository'

          # (Opcional) limpar pacote problemático
          - bash: rm -rf "$(Pipeline.Workspace)/.m2/repository/net/bytebuddy/byte-buddy" || true
            displayName: 'Limpa cache corrompido (byte-buddy)'

          # Build e testes
          - task: Maven@4
            displayName: 'Maven test & package (boot repackage)'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean test package spring-boot:repackage'
              options: >
                -U --batch-mode --no-transfer-progress
                -Dmaven.repo.local="$(Pipeline.Workspace)/.m2/repository"
                -Dmaven.wagon.http.retryHandler.count=5
                -Dmaven.wagon.http.pool=false
                -Dmaven.wagon.http.timeout=120000
                -Dmaven.wagon.httpconnectionManager.ttlSeconds=120
                -Dmaven.resolver.transport=wagon
                -Dhttps.protocols=TLSv1.2
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenOptions: '-Xms256m -Xmx1024m'
              publishJUnitResults: false
              testResultsFiles: '**/surefire-reports/TEST-*.xml'

          # Publica SOMENTE o .jar como artefato de pipeline
          - task: PublishPipelineArtifact@1
            displayName: 'Publicar artefato (.jar)'
            inputs:
              targetPath: 'target'
              artifact: '$(artifactName)'

# =========================
# DEPLOY
# =========================
  - stage: Deploy
    displayName: 'Deploy to App Service'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToProd
        displayName: 'Deploy – $(appName)'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: 'Baixar artefato'
                  inputs:
                    buildType: 'current'
                    artifactName: '$(artifactName)'
                    targetPath: '$(Pipeline.Workspace)/$(artifactName)'

                - bash: ls -lah "$(Pipeline.Workspace)/$(artifactName)"
                  displayName: 'Listar artefato baixado'

                # Deploy do .jar para App Service Linux
                - task: AzureWebApp@1
                  displayName: 'Azure WebApp Deploy (.jar)'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(appName)'
                    package: '$(packagePath)'
