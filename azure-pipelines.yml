# Azure DevOps Pipeline (YAML) – Sprint4DevOps
# CI: build + testes + artefato
# CD: deploy para Azure App Service (Linux) – Java 17 (Spring Boot .jar)

trigger:
  branches:
    include:
      - main

variables:
  azureSubscription: 'SC_Sprint4DevOps'                 # Service Connection
  appName: 'app-sprint4-rm556620'                       # App Service
  artifactName: 'drop'
  packagePath: '$(Pipeline.Workspace)/drop/**/*.jar'    # caminho do .jar publicado

pool:
  vmImage: 'ubuntu-latest'

stages:
# =========================
# BUILD
# =========================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: Build
        displayName: 'Maven build + tests'
        steps:
          - checkout: self

          # Java 17
          - task: JavaToolInstaller@0
            displayName: 'Set Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # Cache do repositório Maven (~/.m2/repository)
          - task: Cache@2
            displayName: 'Cache Maven local (~/.m2)'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              path: ~/.m2/repository
              restoreKeys: |
                maven | "$(Agent.OS)"

          # Limpa artefato possivelmente corrompido (caso do byte-buddy)
          - bash: |
              rm -rf ~/.m2/repository/net/bytebuddy/byte-buddy || true
            displayName: 'Limpa cache corrompido (byte-buddy)'

          # Build com retries e transporte estável
          - task: Maven@4
            displayName: 'Maven test & package (boot repackage)'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean test package spring-boot:repackage'
              options: >
                -U --batch-mode --no-transfer-progress
                -Dmaven.wagon.http.retryHandler.count=5
                -Dmaven.wagon.http.pool=false
                -Dmaven.wagon.http.timeout=120000
                -Dmaven.wagon.httpconnectionManager.ttlSeconds=120
                -Dmaven.resolver.transport=wagon
                -Dhttps.protocols=TLSv1.2
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenOptions: '-Xms256m -Xmx1024m'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'

          # Publica somente os .jar do target como artefato "drop"
          - task: PublishBuildArtifacts@1
            displayName: 'Publicar artefato (.jar)'
            inputs:
              PathtoPublish: 'target'
              ArtifactName: '$(artifactName)'
              publishLocation: 'Container'

# =========================
# DEPLOY
# =========================
  - stage: Deploy
    displayName: 'Deploy to App Service'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToProd
        displayName: 'Deploy – $(appName)'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: $(artifactName)

                # (Opcional) mostra qual .jar foi baixado
                - bash: ls -lah $(Pipeline.Workspace)/$(artifactName)/
                  displayName: 'Listar artefato baixado'

                - task: AzureWebApp@1
                  displayName: 'Azure WebApp Deploy (.jar)'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(appName)'
                    package: '$(packagePath)'
